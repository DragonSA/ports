# Created by: Yukihiro Nakai <nakai@FreeBSD.org>
# $FreeBSD: head/lang/mono/Makefile 439898 2017-05-01 14:32:54Z dvl $

PORTNAME=	mono
PORTVERSION=	4.8.1.0
CATEGORIES=	lang
DISTFILES=	monolite-${MONOLITE_VERSION}-latest.tar.gz:monolite
MASTER_SITES=	http://download.mono-project.com/monolite/:monolite

MAINTAINER=	mono@FreeBSD.org
COMMENT=	Open source implementation of .NET Development Framework

LICENSE=	MIT
LICENSE_FILE=	${WRKSRC}/LICENSE

BUILD_DEPENDS=	p5-XML-Parser>=0:textproc/p5-XML-Parser \
		bash:shells/bash
LIB_DEPENDS=	libinotify.so:devel/libinotify
RUN_DEPENDS=	${PYTHON_PKGNAMEPREFIX}pillow>=0:graphics/py-pillow

MONOLITE_VERSION=	156
USE_GITHUB=	yes
GH_TAGNAME=	${PORTNAME}-${PORTVERSION}
GH_TUPLE=	mono:Lucene.Net.Light:85978b7:1/external/Lucene.Net.Light \
		mono:Newtonsoft.Json:471c3e0:2/external/Newtonsoft.Json \
		mono:NuGet.BuildTasks:04bdab5:3/external/nuget-buildtasks \
		mono:aspnetwebstack:e77b12e:4/external/aspnetwebstack \
		mono:buildtools:9b6ee86:5/external/buildtools \
		mono:cecil:2b39856:6/external/cecil \
		mono:cecil:33d50b8:7/external/cecil-legacy \
		mono:ikdasm:e4deabf:8/external/ikdasm \
		mono:ikvm-fork:367864e:9/external/ikvm \
		mono:reference-assemblies:6c77197:10/external/binary-reference-assemblies \
		mono:rx:b29a4b0:11/external/rx

USES=		autoreconf bison compiler:c11 cpe gettext gmake iconv libtool pathfix \
		perl5 python shebangfix tar:bzip2
USE_GNOME=	glib20
USE_PERL5=	build
GNU_CONFIGURE=	yes
SHEBANG_FILES=	${WRKSRC}/scripts/mono-heapviz
USE_LDCONFIG=	yes

CONFIGURE_ARGS=	--disable-dtrace
CONFIGURE_ENV=	ac_cv_header_sys_inotify_h=no

MAKE_ENV=	MONO_SHARED_DIR="${WRKDIR}" \
		INSTALL_STRIP_FLAG="${STRIP}" \
		TZ=UTC

TEST_TARGET=	check
TEST_WRKSRC=	${WRKSRC}/mono/tests

ONLY_FOR_ARCHS=	i386 amd64 armv6 powerpc
PORTSCOUT=	limit:^\d+\.\d+\.[1-9]\d*

post-extract:
	${MKDIR} ${WRKSRC}/mcs/class/lib
	${MV} ${WRKDIR}/monolite-${MONOLITE_VERSION}-latest ${WRKSRC}/mcs/class/lib/monolite

post-patch:
	${REINPLACE_CMD} -e 's|^#!/bin/bash|#!/usr/bin/env bash|g' \
		${WRKSRC}/scripts/mono-find-provides.in \
		${WRKSRC}/scripts/mono-find-requires.in \
		${WRKSRC}/scripts/mono-test-install
	${FIND} ${WRKSRC} -name '*.sh' | ${XARGS} ${REINPLACE_CMD} \
		-e 's|^#!/bin/bash|#!/bin/sh|g'
	${SED} 's/tarball/${PORTVERSION}/' ${WRKSRC}/mono/mini/Makefile.am.in \
		> ${WRKSRC}/mono/mini/Makefile.am

post-configure:
	${REINPLACE_CMD} -e 's|share\/man|man|g' \
		${WRKSRC}/mcs/jay/Makefile

.include <bsd.port.mk>
